import bcrypt from "bcryptjs";
import User from "../models/User.model.js";
import { asyncHandler } from "../utils/asyncHandler.js";
import generateOtp from "../utils/generateOtp.js";
import sendEmail from "../config/sendEmail.js";
import forgotPasswordTemplate from "../utils/forgotPasswordTemplate.js";
import uploadImageCloudinary from "../utils/uploadImageCloudinary.js";

// ---------------- PROFILE ----------------
export const getProfileController = asyncHandler(async (req, res) => {
  res.json({ success: true, user: req.user });
});

// ---------------- UPDATE PROFILE ----------------
export const updateProfileController = asyncHandler(async (req, res) => {
  delete req.body.role; // role cannot be changed
  const user = await User.findByIdAndUpdate(req.user._id, req.body, { new: true });
  res.json({ success: true, message: "Profile updated", user });
});

// ---------------- UPLOAD AVATAR ----------------
export const uploadAvatarController = asyncHandler(async (req, res) => {
  const result = await uploadImageCloudinary(req.file);
  req.user.avatar = result.url;
  await req.user.save();
  res.json({ success: true, message: "Avatar uploaded", avatar: result.url });
});

// ---------------- FORGOT PASSWORD ----------------
export const forgotPasswordController = asyncHandler(async (req, res) => {
  const { email } = req.body;
  const user = await User.findOne({ email });
  if (!user) return res.status(404).json({ success: false, message: "User not found" });

  const otp = generateOtp();
  user.otp = otp;
  user.otpExpiry = Date.now() + 5*60*1000;
  await user.save();

  await sendEmail(email, "Reset Password OTP", forgotPasswordTemplate({ name: user.fullName, otp }));
  res.json({ success: true, message: "OTP sent to email" });
});

// ---------------- RESET PASSWORD ----------------
export const resetPasswordController = asyncHandler(async (req, res) => {
  const { email, otp,  } = req.body;
  const user = await User.findOne({ email }).select("+otp +otpExpiry");
  if (!user) return res.status(404).json({ success: false, message: "User not found" });

  if (user.otp !== otp || user.otpExpiry < Date.now())
    return res.status(400).json({ success: false, message: "Invalid or expired OTP" });

  user.password = await bcrypt.hash(newPassword, 10);
  user.otp = null;
  user.otpExpiry = null;newPassword
  await user.save();

  res.json({ success: true, message: "Password reset successful" });
});
